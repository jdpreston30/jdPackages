# Dockerfile for Reproducible R Environment
# Project: {{PROJECT_NAME}}
# Generated by jdPackages::repo_template()
#
# This Dockerfile creates a fully containerised version of the analysis
# environment. It is typically configured AFTER the project is complete
# and all packages are locked in renv.lock.
#
# Build:   docker compose build
# Run:     docker compose up
# Or:      docker build -t {{PROJECT_NAME}} .
#          docker run --rm -v $(pwd)/Outputs:/analysis/Outputs {{PROJECT_NAME}}
#
# See QUICKSTART.txt for full Docker deployment instructions.

FROM rocker/r-ver:4.5.1

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Core build tools
    build-essential \
    gfortran \
    cmake \
    # Document generation
    ghostscript \
    pandoc \
    imagemagick \
    # XML and networking
    libxml2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    libgit2-dev \
    # Graphics and fonts
    libfontconfig1-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    libcairo2-dev \
    libxt-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    # LaTeX/PDF generation
    wget \
    perl \
    # HDF5 / bioinformatics
    libhdf5-dev \
    libnetcdf-dev \
    libfftw3-dev \
    # Additional
    libgsl-dev \
    libgmp-dev \
    libglpk-dev \
    graphviz \
    libgraphviz-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set up renv for exact package restoration
RUN Rscript -e "install.packages('renv', repos='https://cloud.r-project.org')"

# Copy project files
WORKDIR /analysis
COPY renv.lock renv.lock
COPY .Rprofile .Rprofile
COPY renv/activate.R renv/activate.R
COPY renv/settings.json renv/settings.json

# Copy all project files (needed before renv restore so renv can scan dependencies)
COPY DESCRIPTION .
COPY R/ R/
COPY All_Run/ All_Run/

# Restore R packages from renv.lock (captures exact versions from development machine)
RUN Rscript -e "renv::restore()"

# Install TinyTeX for PDF generation
RUN Rscript -e "tinytex::install_tinytex()"
ENV PATH="${PATH}:/root/bin"

# Default command â€” run the full pipeline
CMD ["Rscript", "-e", "source('All_Run/run.R')"]
